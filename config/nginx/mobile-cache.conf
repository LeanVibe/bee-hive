# Mobile-optimized caching configuration

# Cache zones for different content types
proxy_cache_path /var/cache/nginx/mobile levels=1:2 keys_zone=mobile_cache:100m max_size=1g inactive=60m use_temp_path=off;
proxy_cache_path /var/cache/nginx/api levels=1:2 keys_zone=api_cache:50m max_size=500m inactive=30m use_temp_path=off;
proxy_cache_path /var/cache/nginx/static levels=1:2 keys_zone=static_cache:200m max_size=2g inactive=24h use_temp_path=off;

# Mobile cache key
map $http_user_agent $mobile_cache_key {
    ~*iPhone|iPad|Android|Mobile "mobile";
    default "desktop";
}

# Cache control for mobile assets
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?|ttf|eot)$ {
    proxy_cache static_cache;
    proxy_cache_valid 200 304 24h;
    proxy_cache_valid 404 1m;
    proxy_cache_key "$scheme$request_method$host$request_uri$mobile_cache_key";
    
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Cache-Status $upstream_cache_status;
    
    # Vary header for mobile optimization
    add_header Vary "Accept-Encoding, User-Agent";
    
    # CORS headers for mobile PWA
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, OPTIONS";
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept";
}

# API response caching for mobile
location ~* ^/api/(dashboard|status|health)$ {
    proxy_cache api_cache;
    proxy_cache_valid 200 5m;
    proxy_cache_valid 404 1m;
    proxy_cache_key "$scheme$request_method$host$request_uri$arg_mobile";
    
    # Cache only GET requests
    proxy_cache_methods GET HEAD;
    
    # Add cache headers
    add_header X-Cache-Status $upstream_cache_status;
    add_header Cache-Control "public, max-age=300";
    
    # Bypass cache for authenticated requests
    proxy_cache_bypass $http_authorization;
    proxy_no_cache $http_authorization;
}

# Mobile-specific WebSocket optimization
location /ws/mobile/ {
    # WebSocket headers
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Mobile-specific headers
    proxy_set_header X-Mobile-Client "true";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Optimized timeouts for mobile
    proxy_connect_timeout 10s;
    proxy_send_timeout 86400s;
    proxy_read_timeout 86400s;
    
    # No caching for WebSocket
    proxy_buffering off;
    proxy_cache off;
}

# Service Worker caching
location = /sw.js {
    expires 0;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Service-Worker-Allowed "/";
}

# PWA manifest caching
location ~* \.(webmanifest|manifest\.json)$ {
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
    add_header Content-Type "application/manifest+json";
}

# Push notification endpoint
location /api/mobile/notifications/ {
    # No caching for notifications
    proxy_cache off;
    
    # Rate limiting
    limit_req zone=mobile_api burst=5 nodelay;
    
    # Headers for FCM
    proxy_set_header X-FCM-Client "true";
    proxy_set_header Content-Type "application/json";
}

# Mobile analytics endpoint
location /api/mobile/analytics/ {
    # Light caching for analytics
    proxy_cache api_cache;
    proxy_cache_valid 200 1m;
    proxy_cache_key "$scheme$request_method$host$request_uri$arg_timestamp";
}