# PostgreSQL Configuration for LeanVibe Agent Hive Production
# Optimized for production workloads with reliability and performance

# Basic Settings
listen_addresses = '*'
port = 5432
max_connections = 200

# Memory Settings (production-optimized)
shared_buffers = 2GB                    # 25% of available memory (8GB system)
effective_cache_size = 6GB              # 75% of available memory
work_mem = 16MB                         # Increased for complex queries
maintenance_work_mem = 512MB            # For maintenance operations
huge_pages = try                        # Use huge pages for better memory management

# WAL Settings (production-grade reliability)
wal_level = replica                     # Support for replication
fsync = on                             # Ensure data integrity
synchronous_commit = on                # Wait for WAL to be written
full_page_writes = on                  # Protect against partial page writes
wal_buffers = 64MB                     # Large WAL buffer for high throughput
wal_compression = on                   # Compress WAL records
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
max_wal_size = 2GB
min_wal_size = 1GB

# Replication Settings (for future scaling)
hot_standby = on
max_wal_senders = 3
wal_keep_segments = 64
archive_mode = on
archive_command = 'cp %p /backups/archive/%f'

# Query Planner Settings
random_page_cost = 1.1                 # SSD-optimized
effective_io_concurrency = 200         # For SSD storage
max_worker_processes = 8               # Match CPU cores
max_parallel_workers = 8
max_parallel_workers_per_gather = 4
max_parallel_maintenance_workers = 4

# Connection Settings
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3
authentication_timeout = 1min

# Resource Management
temp_file_limit = 10GB
shared_preload_libraries = 'pg_stat_statements,pg_hint_plan'

# Logging (production-grade)
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on
log_statement = 'ddl'                  # Log schema changes only
log_min_duration_statement = 5000      # Log slow queries (5+ seconds)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 100MB
log_autovacuum_min_duration = 10000

# Error Reporting
log_min_messages = warning
log_min_error_statement = error
log_error_verbosity = default

# Statistics Collection
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
track_activity_query_size = 4096
stats_temp_directory = '/var/run/postgresql/stats_temp'

# Autovacuum (production-tuned)
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s
autovacuum_vacuum_threshold = 100
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000

# Lock Management
deadlock_timeout = 1s
lock_timeout = 60s                     # Increased for production
statement_timeout = 600s               # 10 minutes max query time
idle_in_transaction_session_timeout = 300s

# Security Settings
ssl = on
ssl_cert_file = '/etc/ssl/certs/postgresql.crt'
ssl_key_file = '/etc/ssl/private/postgresql.key'
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
ssl_prefer_server_ciphers = on
password_encryption = scram-sha-256
row_security = on

# Extension Configuration
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = off
pg_stat_statements.save = on

# Memory-Related Settings
temp_buffers = 32MB
max_prepared_transactions = 100
max_locks_per_transaction = 256
max_pred_locks_per_transaction = 256

# Background Writer Settings
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0
bgwriter_flush_after = 512kB

# WAL Writer Settings
wal_writer_delay = 200ms
wal_writer_flush_after = 1MB

# Checkpoint Settings
checkpoint_flush_after = 256kB
checkpoint_warning = 300s

# Cost-Based Vacuum Settings
vacuum_cost_delay = 10ms
vacuum_cost_page_hit = 1
vacuum_cost_page_miss = 10
vacuum_cost_page_dirty = 20
vacuum_cost_limit = 2000