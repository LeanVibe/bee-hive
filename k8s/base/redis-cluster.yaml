---
# Redis Cluster for high-availability distributed caching
# Epic 3 Phase 2: Horizontal Scaling & Performance

# Redis Cluster ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-cluster-config
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster
    scaling.leanvibe.com/epic: "3-phase-2"
data:
  redis.conf: |
    # Redis Cluster Configuration
    port 6379
    cluster-enabled yes
    cluster-config-file nodes.conf
    cluster-node-timeout 5000
    cluster-announce-port 6379
    cluster-announce-bus-port 16379
    appendonly yes
    appendfsync everysec
    
    # Memory optimization for scaling
    maxmemory 1gb
    maxmemory-policy allkeys-lru
    
    # Performance optimizations
    tcp-keepalive 60
    tcp-backlog 511
    timeout 300
    
    # Cluster-specific settings
    cluster-require-full-coverage no
    cluster-allow-reads-when-down no
    
    # Security
    protected-mode no
    
    # Logging
    loglevel notice
    
    # Persistence for session management
    save 900 1
    save 300 10
    save 60 10000
  
  bootstrap.sh: |
    #!/bin/bash
    set -e
    
    # Wait for Redis to be ready
    until redis-cli ping; do
      echo "Waiting for Redis to start..."
      sleep 1
    done
    
    # Get pod IP
    POD_IP=$(hostname -i)
    echo "Pod IP: $POD_IP"
    
    # Initialize cluster if this is the first node
    if [[ "${HOSTNAME}" == "redis-cluster-0" ]]; then
      echo "Initializing Redis cluster..."
      
      # Wait for all nodes to be ready
      for i in {0..5}; do
        until nc -z redis-cluster-$i.redis-cluster-headless 6379; do
          echo "Waiting for redis-cluster-$i to be ready..."
          sleep 5
        done
      done
      
      # Create cluster
      redis-cli --cluster create \
        redis-cluster-0.redis-cluster-headless:6379 \
        redis-cluster-1.redis-cluster-headless:6379 \
        redis-cluster-2.redis-cluster-headless:6379 \
        redis-cluster-3.redis-cluster-headless:6379 \
        redis-cluster-4.redis-cluster-headless:6379 \
        redis-cluster-5.redis-cluster-headless:6379 \
        --cluster-replicas 1 \
        --cluster-yes
      
      echo "Redis cluster initialized successfully"
    else
      echo "Waiting for cluster to be initialized..."
      # Wait for cluster to be ready
      until redis-cli cluster info | grep cluster_state:ok; do
        echo "Cluster not ready yet, waiting..."
        sleep 10
      done
    fi
    
    echo "Redis node ready for cluster operations"

---
# Redis Cluster Headless Service
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster-headless
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - port: 6379
    targetPort: 6379
    name: redis
  - port: 16379
    targetPort: 16379
    name: cluster-bus
  selector:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster

---
# Redis Cluster Service (for client connections)
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster
    scaling.leanvibe.com/epic: "3-phase-2"
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9121"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ports:
  - port: 6379
    targetPort: 6379
    name: redis
  - port: 9121
    targetPort: 9121
    name: metrics
  selector:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster

---
# Redis Cluster StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  serviceName: redis-cluster-headless
  replicas: 6  # 3 masters + 3 replicas
  selector:
    matchLabels:
      app.kubernetes.io/name: leanvibe-agent-hive
      app.kubernetes.io/component: redis-cluster
  template:
    metadata:
      labels:
        app.kubernetes.io/name: leanvibe-agent-hive
        app.kubernetes.io/component: redis-cluster
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9121"
        prometheus.io/path: "/metrics"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
      initContainers:
      - name: config-init
        image: redis:7-alpine
        command:
        - /bin/sh
        - -c
        - |
          cp /readonly-config/redis.conf /data/redis.conf
          echo "cluster-announce-ip $(hostname -i)" >> /data/redis.conf
        volumeMounts:
        - name: redis-config
          mountPath: /readonly-config
        - name: data
          mountPath: /data
        securityContext:
          runAsNonRoot: true
          runAsUser: 999
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
      containers:
      - name: redis
        image: redis:7-alpine
        command:
        - redis-server
        - /data/redis.conf
        ports:
        - containerPort: 6379
          name: redis
        - containerPort: 16379
          name: cluster-bus
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: data
          mountPath: /data
        livenessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 15
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        securityContext:
          runAsNonRoot: true
          runAsUser: 999
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
      - name: redis-exporter
        image: oliver006/redis_exporter:latest
        ports:
        - containerPort: 9121
          name: metrics
        env:
        - name: REDIS_ADDR
          value: "redis://localhost:6379"
        - name: REDIS_EXPORTER_INCL_SYSTEM_METRICS
          value: "true"
        - name: REDIS_EXPORTER_CHECK_KEYS
          value: "scaling:*,system:*,agent:*"
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        securityContext:
          runAsNonRoot: true
          runAsUser: 999
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
      volumes:
      - name: redis-config
        configMap:
          name: redis-cluster-config
          defaultMode: 0644
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - redis-cluster
              topologyKey: kubernetes.io/hostname
      tolerations:
      - key: "kubernetes.io/arch"
        operator: "Equal"
        value: "amd64"
        effect: "NoSchedule"
  volumeClaimTemplates:
  - metadata:
      name: data
      labels:
        app.kubernetes.io/name: leanvibe-agent-hive
        app.kubernetes.io/component: redis-cluster
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
      storageClassName: "fast-ssd"  # Use fast storage for Redis

---
# Job to initialize Redis cluster
apiVersion: batch/v1
kind: Job
metadata:
  name: redis-cluster-init
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: leanvibe-agent-hive
        app.kubernetes.io/component: redis-cluster-init
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
      containers:
      - name: redis-cluster-init
        image: redis:7-alpine
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for Redis cluster nodes to be ready..."
          
          # Wait for all nodes to be ready
          for i in {0..5}; do
            echo "Checking redis-cluster-$i..."
            until nc -z redis-cluster-$i.redis-cluster-headless 6379; do
              echo "Waiting for redis-cluster-$i to be ready..."
              sleep 5
            done
            echo "redis-cluster-$i is ready"
          done
          
          echo "All nodes ready. Initializing cluster..."
          
          # Check if cluster is already initialized
          if redis-cli -h redis-cluster-0.redis-cluster-headless cluster nodes | grep -q master; then
            echo "Cluster already initialized"
            exit 0
          fi
          
          # Initialize cluster
          redis-cli --cluster create \
            redis-cluster-0.redis-cluster-headless:6379 \
            redis-cluster-1.redis-cluster-headless:6379 \
            redis-cluster-2.redis-cluster-headless:6379 \
            redis-cluster-3.redis-cluster-headless:6379 \
            redis-cluster-4.redis-cluster-headless:6379 \
            redis-cluster-5.redis-cluster-headless:6379 \
            --cluster-replicas 1 \
            --cluster-yes
          
          echo "Cluster initialization completed successfully"
          
          # Verify cluster status
          redis-cli -h redis-cluster-0.redis-cluster-headless cluster info
          redis-cli -h redis-cluster-0.redis-cluster-headless cluster nodes
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        securityContext:
          runAsNonRoot: true
          runAsUser: 999
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
  backoffLimit: 5
  activeDeadlineSeconds: 600

---
# Redis Cluster Monitoring Service
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster-monitoring
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - port: 9121
    targetPort: 9121
    name: metrics
  selector:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster

---
# ServiceMonitor for Prometheus
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: redis-cluster-metrics
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: leanvibe-agent-hive
      app.kubernetes.io/component: redis-cluster
  endpoints:
  - port: metrics
    path: /metrics
    interval: 15s
    scrapeTimeout: 10s
    metricRelabelings:
    # Label metrics for scaling automation
    - sourceLabels: [__name__]
      targetLabel: component
      replacement: redis-cluster
    - sourceLabels: [__name__]
      targetLabel: scaling_relevant
      regex: '(redis_connected_clients|redis_used_memory_percent|redis_keyspace_hits_total|redis_commands_processed_total).*'
      replacement: 'true'

---
# Network Policy for Redis Cluster
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-cluster-network-policy
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: leanvibe-agent-hive
      app.kubernetes.io/component: redis-cluster
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow cluster communication between Redis nodes
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: leanvibe-agent-hive
          app.kubernetes.io/component: redis-cluster
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 16379
  # Allow API pods to connect
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: leanvibe-agent-hive
          app.kubernetes.io/component: api
    ports:
    - protocol: TCP
      port: 6379
  # Allow monitoring
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9121
  egress:
  # Allow cluster communication
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: leanvibe-agent-hive
          app.kubernetes.io/component: redis-cluster
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 16379
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53

---
# Pod Disruption Budget for Redis Cluster
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: redis-cluster-pdb
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  # Ensure at least 4 nodes (2 masters + 2 replicas) remain available
  minAvailable: 4
  selector:
    matchLabels:
      app.kubernetes.io/name: leanvibe-agent-hive
      app.kubernetes.io/component: redis-cluster

---
# CronJob for Redis Cluster Health Check
apiVersion: batch/v1
kind: CronJob
metadata:
  name: redis-cluster-health-check
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: redis-cluster
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  schedule: "*/5 * * * *"  # Every 5 minutes
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: leanvibe-agent-hive
            app.kubernetes.io/component: redis-cluster-health
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 999
            runAsGroup: 999
            fsGroup: 999
          containers:
          - name: health-check
            image: redis:7-alpine
            command:
            - /bin/sh
            - -c
            - |
              echo "Performing Redis cluster health check..."
              
              # Check cluster status
              cluster_info=$(redis-cli -h redis-cluster cluster info)
              cluster_state=$(echo "$cluster_info" | grep cluster_state | cut -d: -f2)
              
              if [ "$cluster_state" != "ok" ]; then
                echo "ALERT: Cluster state is $cluster_state"
                exit 1
              fi
              
              # Check node count
              node_count=$(redis-cli -h redis-cluster cluster nodes | wc -l)
              if [ "$node_count" -lt 6 ]; then
                echo "ALERT: Only $node_count nodes in cluster (expected 6)"
                exit 1
              fi
              
              # Check master count
              master_count=$(redis-cli -h redis-cluster cluster nodes | grep master | wc -l)
              if [ "$master_count" -ne 3 ]; then
                echo "ALERT: $master_count masters in cluster (expected 3)"
                exit 1
              fi
              
              # Performance test - basic operations
              redis-cli -h redis-cluster set health_check_test "$(date)"
              test_result=$(redis-cli -h redis-cluster get health_check_test)
              redis-cli -h redis-cluster del health_check_test
              
              if [ -z "$test_result" ]; then
                echo "ALERT: Basic Redis operations failing"
                exit 1
              fi
              
              echo "Cluster health check passed - all systems operational"
            resources:
              requests:
                memory: "32Mi"
                cpu: "50m"
              limits:
                memory: "64Mi"
                cpu: "100m"
            securityContext:
              runAsNonRoot: true
              runAsUser: 999
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                - ALL
      backoffLimit: 3
      activeDeadlineSeconds: 120