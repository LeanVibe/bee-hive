---
# PostgreSQL Cluster for Database Scaling
# Epic 3 Phase 2: Horizontal Scaling & Performance
# Provides read replicas, connection pooling, and high availability

# PostgreSQL Primary ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-primary-config
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-primary
    scaling.leanvibe.com/epic: "3-phase-2"
data:
  postgresql.conf: |
    # Connection and Authentication
    max_connections = 200
    shared_preload_libraries = 'pg_stat_statements,auto_explain'
    
    # Memory Configuration (optimized for scaling)
    shared_buffers = '1GB'
    effective_cache_size = '3GB'
    work_mem = '16MB'
    maintenance_work_mem = '256MB'
    dynamic_shared_memory_type = posix
    
    # Write Ahead Logging (WAL) for Replication
    wal_level = replica
    max_wal_senders = 10
    max_replication_slots = 10
    wal_keep_segments = 100
    wal_sender_timeout = 60s
    
    # Replication and Recovery
    hot_standby = on
    wal_receiver_timeout = 60s
    max_standby_streaming_delay = 30s
    
    # Archiving for Point-in-time Recovery
    archive_mode = on
    archive_command = 'cp %p /var/lib/postgresql/archive/%f'
    archive_timeout = 300
    
    # Performance Tuning
    random_page_cost = 1.1
    effective_io_concurrency = 200
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    default_statistics_target = 100
    
    # Connection Pooling Support
    tcp_keepalives_idle = 600
    tcp_keepalives_interval = 30
    tcp_keepalives_count = 3
    
    # Query Performance
    auto_explain.log_min_duration = 1000ms
    auto_explain.log_analyze = on
    auto_explain.log_buffers = on
    
    # Monitoring
    log_destination = 'stderr'
    logging_collector = on
    log_directory = '/var/lib/postgresql/log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_min_duration_statement = 1000ms
    log_checkpoints = on
    log_connections = on
    log_disconnections = on
    log_lock_waits = on
    log_temp_files = 1024
    
    # Vacuum and Statistics
    autovacuum = on
    autovacuum_max_workers = 3
    autovacuum_naptime = 1min
    track_activities = on
    track_counts = on
    track_io_timing = on
    track_functions = all
  
  pg_hba.conf: |
    # Database administrative login by Unix domain socket
    local   all             postgres                                trust
    
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    
    # "local" is for Unix domain socket connections only
    local   all             all                                     trust
    
    # IPv4 local connections
    host    all             all             127.0.0.1/32            trust
    host    all             all             0.0.0.0/0               md5
    
    # IPv6 local connections
    host    all             all             ::1/128                 trust
    
    # Replication connections
    host    replication     postgres        0.0.0.0/0               md5

---
# PostgreSQL Replica ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-replica-config
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-replica
    scaling.leanvibe.com/epic: "3-phase-2"
data:
  postgresql.conf: |
    # Connection and Authentication
    max_connections = 100
    shared_preload_libraries = 'pg_stat_statements'
    
    # Memory Configuration (optimized for read workloads)
    shared_buffers = '1GB'
    effective_cache_size = '3GB'
    work_mem = '32MB'
    maintenance_work_mem = '128MB'
    dynamic_shared_memory_type = posix
    
    # Replica Configuration
    hot_standby = on
    hot_standby_feedback = on
    max_standby_streaming_delay = 30s
    max_standby_archive_delay = 60s
    wal_receiver_timeout = 60s
    
    # Performance Tuning (read-optimized)
    random_page_cost = 1.0
    effective_io_concurrency = 300
    default_statistics_target = 500
    
    # Connection Settings
    tcp_keepalives_idle = 600
    tcp_keepalives_interval = 30
    tcp_keepalives_count = 3
    
    # Monitoring
    log_destination = 'stderr'
    logging_collector = on
    log_directory = '/var/lib/postgresql/log'
    log_filename = 'postgresql-replica-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_min_duration_statement = 2000ms
    log_connections = on
    log_disconnections = on
    
    # Statistics
    track_activities = on
    track_counts = on
    track_io_timing = on
    track_functions = all
  
  recovery.conf: |
    standby_mode = 'on'
    primary_conninfo = 'host=postgres-primary port=5432 user=postgres'
    recovery_target_timeline = 'latest'
    
  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    local   all             all                                     trust
    host    all             all             127.0.0.1/32            trust
    host    all             all             0.0.0.0/0               md5
    host    all             all             ::1/128                 trust

---
# PostgreSQL Primary Service
apiVersion: v1
kind: Service
metadata:
  name: postgres-primary
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-primary
    scaling.leanvibe.com/epic: "3-phase-2"
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9187"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ports:
  - port: 5432
    targetPort: 5432
    name: postgres
  - port: 9187
    targetPort: 9187
    name: metrics
  selector:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-primary

---
# PostgreSQL Replica Service
apiVersion: v1
kind: Service
metadata:
  name: postgres-replica
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-replica
    scaling.leanvibe.com/epic: "3-phase-2"
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9187"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ports:
  - port: 5432
    targetPort: 5432
    name: postgres
  - port: 9187
    targetPort: 9187
    name: metrics
  selector:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-replica

---
# PostgreSQL Primary Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-primary
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-primary
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  replicas: 1  # Primary is single instance
  strategy:
    type: Recreate  # Prevent multiple primaries
  selector:
    matchLabels:
      app.kubernetes.io/name: leanvibe-agent-hive
      app.kubernetes.io/component: postgres-primary
  template:
    metadata:
      labels:
        app.kubernetes.io/name: leanvibe-agent-hive
        app.kubernetes.io/component: postgres-primary
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9187"
        prometheus.io/path: "/metrics"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 70
        runAsGroup: 70
        fsGroup: 70
      initContainers:
      - name: postgres-init
        image: postgres:15-alpine
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Initializing PostgreSQL primary..."
          
          # Copy configuration files
          cp /config/postgresql.conf /var/lib/postgresql/data/
          cp /config/pg_hba.conf /var/lib/postgresql/data/
          
          # Create archive directory
          mkdir -p /var/lib/postgresql/archive
          mkdir -p /var/lib/postgresql/log
          chown -R postgres:postgres /var/lib/postgresql/
          
          # Initialize database if needed
          if [ ! -f /var/lib/postgresql/data/PG_VERSION ]; then
            sudo -u postgres initdb -D /var/lib/postgresql/data
          fi
          
          echo "Primary initialization completed"
        volumeMounts:
        - name: postgres-config
          mountPath: /config
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: postgres-archive
          mountPath: /var/lib/postgresql/archive
        securityContext:
          runAsUser: 0  # Needed for chown
          allowPrivilegeEscalation: true
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
          name: postgres
        env:
        - name: POSTGRES_DB
          value: "leanvibe"
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: leanvibe-secrets
              key: POSTGRES_PASSWORD
        - name: PGDATA
          value: "/var/lib/postgresql/data"
        - name: POSTGRES_INITDB_ARGS
          value: "--auth-host=md5"
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: postgres-archive
          mountPath: /var/lib/postgresql/archive
        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
            - -d
            - leanvibe
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
            - -d
            - leanvibe
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        securityContext:
          runAsNonRoot: true
          runAsUser: 70
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
            - ALL
      - name: postgres-exporter
        image: quay.io/prometheuscommunity/postgres-exporter:latest
        ports:
        - containerPort: 9187
          name: metrics
        env:
        - name: DATA_SOURCE_NAME
          value: "postgresql://postgres:$(POSTGRES_PASSWORD)@localhost:5432/leanvibe?sslmode=disable"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: leanvibe-secrets
              key: POSTGRES_PASSWORD
        - name: PG_EXPORTER_EXTEND_QUERY_PATH
          value: "/etc/postgres_exporter/queries.yaml"
        volumeMounts:
        - name: exporter-queries
          mountPath: /etc/postgres_exporter
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        securityContext:
          runAsNonRoot: true
          runAsUser: 70
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
      volumes:
      - name: postgres-config
        configMap:
          name: postgres-primary-config
      - name: postgres-data
        persistentVolumeClaim:
          claimName: postgres-primary-data
      - name: postgres-archive
        persistentVolumeClaim:
          claimName: postgres-primary-archive
      - name: exporter-queries
        configMap:
          name: postgres-exporter-queries
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - postgres-replica
            topologyKey: kubernetes.io/hostname
      tolerations:
      - key: "kubernetes.io/arch"
        operator: "Equal"
        value: "amd64"
        effect: "NoSchedule"

---
# PostgreSQL Replica Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-replica
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-replica
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  replicas: 2  # Start with 2 read replicas
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: leanvibe-agent-hive
      app.kubernetes.io/component: postgres-replica
  template:
    metadata:
      labels:
        app.kubernetes.io/name: leanvibe-agent-hive
        app.kubernetes.io/component: postgres-replica
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9187"
        prometheus.io/path: "/metrics"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 70
        runAsGroup: 70
        fsGroup: 70
      initContainers:
      - name: replica-setup
        image: postgres:15-alpine
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Setting up PostgreSQL replica..."
          
          # Wait for primary to be ready
          until pg_isready -h postgres-primary -p 5432 -U postgres; do
            echo "Waiting for primary database..."
            sleep 5
          done
          
          # Create base backup from primary
          if [ ! -f /var/lib/postgresql/data/PG_VERSION ]; then
            echo "Creating base backup from primary..."
            PGPASSWORD=$POSTGRES_PASSWORD pg_basebackup -h postgres-primary -D /var/lib/postgresql/data -U postgres -P -W -R
            
            # Copy replica configuration
            cp /config/postgresql.conf /var/lib/postgresql/data/
            cp /config/recovery.conf /var/lib/postgresql/data/
            cp /config/pg_hba.conf /var/lib/postgresql/data/
            
            # Create recovery signal for PostgreSQL 12+
            touch /var/lib/postgresql/data/standby.signal
          fi
          
          # Ensure proper ownership
          chown -R postgres:postgres /var/lib/postgresql/data
          
          echo "Replica setup completed"
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: leanvibe-secrets
              key: POSTGRES_PASSWORD
        volumeMounts:
        - name: postgres-replica-config
          mountPath: /config
        - name: postgres-replica-data
          mountPath: /var/lib/postgresql/data
        securityContext:
          runAsUser: 0  # Needed for chown
          allowPrivilegeEscalation: true
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
          name: postgres
        env:
        - name: POSTGRES_DB
          value: "leanvibe"
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: leanvibe-secrets
              key: POSTGRES_PASSWORD
        - name: PGDATA
          value: "/var/lib/postgresql/data"
        - name: PGUSER
          value: "postgres"
        volumeMounts:
        - name: postgres-replica-data
          mountPath: /var/lib/postgresql/data
        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
            - -d
            - leanvibe
          initialDelaySeconds: 60
          periodSeconds: 15
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
            - -d
            - leanvibe
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        securityContext:
          runAsNonRoot: true
          runAsUser: 70
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
            - ALL
      - name: postgres-exporter
        image: quay.io/prometheuscommunity/postgres-exporter:latest
        ports:
        - containerPort: 9187
          name: metrics
        env:
        - name: DATA_SOURCE_NAME
          value: "postgresql://postgres:$(POSTGRES_PASSWORD)@localhost:5432/leanvibe?sslmode=disable"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: leanvibe-secrets
              key: POSTGRES_PASSWORD
        - name: PG_EXPORTER_EXTEND_QUERY_PATH
          value: "/etc/postgres_exporter/queries.yaml"
        volumeMounts:
        - name: exporter-queries
          mountPath: /etc/postgres_exporter
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        securityContext:
          runAsNonRoot: true
          runAsUser: 70
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
      volumes:
      - name: postgres-replica-config
        configMap:
          name: postgres-replica-config
      - name: postgres-replica-data
        emptyDir:
          sizeLimit: 20Gi
      - name: exporter-queries
        configMap:
          name: postgres-exporter-queries
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - postgres-replica
                  - postgres-primary
              topologyKey: kubernetes.io/hostname

---
# PostgreSQL Exporter Queries ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-exporter-queries
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres
    scaling.leanvibe.com/epic: "3-phase-2"
data:
  queries.yaml: |
    # Custom queries for Epic 3 Phase 2 scaling metrics
    
    # Connection metrics
    pg_connections:
      query: "SELECT state, COUNT(*) FROM pg_stat_activity WHERE state IS NOT NULL GROUP BY state"
      master: true
      metrics:
        - state:
            usage: "LABEL"
            description: "Connection state"
        - count:
            usage: "GAUGE"
            description: "Number of connections by state"
    
    # Performance metrics
    pg_slow_queries:
      query: "SELECT query, calls, total_time, mean_time FROM pg_stat_statements WHERE mean_time > 100 ORDER BY mean_time DESC LIMIT 10"
      master: true
      metrics:
        - query:
            usage: "LABEL"
            description: "Slow query text"
        - calls:
            usage: "COUNTER"
            description: "Number of times executed"
        - total_time:
            usage: "COUNTER"
            description: "Total time spent in the statement"
        - mean_time:
            usage: "GAUGE"
            description: "Mean time per execution"
    
    # Replication lag
    pg_replication_lag:
      query: "SELECT client_addr, state, pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS lag_bytes FROM pg_stat_replication"
      master: true
      metrics:
        - client_addr:
            usage: "LABEL"
            description: "Replica IP address"
        - state:
            usage: "LABEL"
            description: "Replication state"
        - lag_bytes:
            usage: "GAUGE"
            description: "Replication lag in bytes"
    
    # Cache hit ratio
    pg_cache_hit_ratio:
      query: "SELECT schemaname, tablename, heap_blks_read, heap_blks_hit, CASE WHEN heap_blks_hit + heap_blks_read = 0 THEN 0 ELSE heap_blks_hit::float / (heap_blks_hit + heap_blks_read) END AS hit_ratio FROM pg_statio_user_tables"
      metrics:
        - schemaname:
            usage: "LABEL"
            description: "Schema name"
        - tablename:
            usage: "LABEL"
            description: "Table name"
        - heap_blks_read:
            usage: "COUNTER"
            description: "Number of disk blocks read"
        - heap_blks_hit:
            usage: "COUNTER"
            description: "Number of buffer hits"
        - hit_ratio:
            usage: "GAUGE"
            description: "Cache hit ratio"
    
    # Database size
    pg_database_size:
      query: "SELECT datname, pg_database_size(datname) AS size_bytes FROM pg_database WHERE datname = 'leanvibe'"
      metrics:
        - datname:
            usage: "LABEL"
            description: "Database name"
        - size_bytes:
            usage: "GAUGE"
            description: "Database size in bytes"
    
    # Scaling-specific metrics
    pg_scaling_metrics:
      query: |
        SELECT 
          'concurrent_users' AS metric_name,
          COUNT(*) AS metric_value
        FROM pg_stat_activity 
        WHERE state = 'active'
        UNION ALL
        SELECT 
          'long_running_queries' AS metric_name,
          COUNT(*) AS metric_value
        FROM pg_stat_activity 
        WHERE state = 'active' 
        AND query_start < now() - interval '30 seconds'
      metrics:
        - metric_name:
            usage: "LABEL"
            description: "Scaling metric name"
        - metric_value:
            usage: "GAUGE"
            description: "Scaling metric value"

---
# Persistent Volume Claims for PostgreSQL Primary
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-primary-data
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-primary
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: "fast-ssd"

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-primary-archive
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-primary
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: "standard"

---
# HPA for PostgreSQL Replicas
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: postgres-replica-hpa
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-replica
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: postgres-replica
  minReplicas: 2
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  - type: Pods
    pods:
      metric:
        name: pg_connections_active
      target:
        type: AverageValue
        averageValue: "50"
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 120
      policies:
      - type: Percent
        value: 50
        periodSeconds: 120
      - type: Pods
        value: 1
        periodSeconds: 120
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 600
      policies:
      - type: Percent
        value: 25
        periodSeconds: 300
      selectPolicy: Min

---
# ServiceMonitor for Prometheus
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-cluster-metrics
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: leanvibe-agent-hive
  endpoints:
  - port: metrics
    path: /metrics
    interval: 30s
    scrapeTimeout: 15s
    metricRelabelings:
    - sourceLabels: [__name__]
      targetLabel: component
      replacement: postgres
    - sourceLabels: [__name__]
      targetLabel: scaling_relevant
      regex: '(pg_connections|pg_replication_lag|pg_cache_hit_ratio|pg_scaling_metrics).*'
      replacement: 'true'

---
# Network Policy for PostgreSQL Cluster
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-cluster-network-policy
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: leanvibe-agent-hive
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow API pods to connect
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: leanvibe-agent-hive
          app.kubernetes.io/component: api
    ports:
    - protocol: TCP
      port: 5432
  # Allow replica-to-primary replication
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: leanvibe-agent-hive
          app.kubernetes.io/component: postgres-replica
    ports:
    - protocol: TCP
      port: 5432
  # Allow monitoring
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9187
  egress:
  # Allow primary-to-replica replication
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: leanvibe-agent-hive
          app.kubernetes.io/component: postgres-replica
    ports:
    - protocol: TCP
      port: 5432
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53

---
# Pod Disruption Budget for PostgreSQL Primary
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: postgres-primary-pdb
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-primary
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: leanvibe-agent-hive
      app.kubernetes.io/component: postgres-primary

---
# Pod Disruption Budget for PostgreSQL Replicas
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: postgres-replica-pdb
  labels:
    app.kubernetes.io/name: leanvibe-agent-hive
    app.kubernetes.io/component: postgres-replica
    scaling.leanvibe.com/epic: "3-phase-2"
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: leanvibe-agent-hive
      app.kubernetes.io/component: postgres-replica