<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto 1fr auto;
            gap: 20px;
            padding: 20px;
            min-height: 100vh;
        }
        
        .dashboard-header {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
        }
        
        .system-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-healthy { background-color: #48bb78; }
        .status-degraded { background-color: #ed8936; }
        .status-critical { background-color: #f56565; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .metrics-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .metric-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 4px;
        }
        
        .metric-subtitle {
            font-size: 0.8rem;
            color: #888;
        }
        
        .agents-panel, .projects-panel, .conflicts-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 600px;
        }
        
        .panel-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .agent-item, .project-item, .conflict-item {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .agent-item:hover, .project-item:hover, .conflict-item:hover {
            background: #edf2f7;
            transform: translateX(5px);
        }
        
        .agent-active { border-left-color: #48bb78; }
        .agent-busy { border-left-color: #ed8936; }
        .agent-idle { border-left-color: #cbd5e0; }
        
        .project-active { border-left-color: #4299e1; }
        .project-planning { border-left-color: #9f7aea; }
        .project-completed { border-left-color: #48bb78; }
        
        .conflict-critical { border-left-color: #f56565; }
        .conflict-high { border-left-color: #ed8936; }
        .conflict-medium { border-left-color: #ecc94b; }
        .conflict-low { border-left-color: #68d391; }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .item-title {
            font-weight: bold;
            color: #2d3748;
        }
        
        .item-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-active { background: #c6f6d5; color: #22543d; }
        .status-busy { background: #fed7aa; color: #9c4221; }
        .status-idle { background: #e2e8f0; color: #4a5568; }
        .status-planning { background: #e9d8fd; color: #553c9a; }
        .status-completed { background: #c6f6d5; color: #22543d; }
        
        .item-details {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #48bb78);
            transition: width 0.3s ease;
        }
        
        .specializations {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }
        
        .specialization-tag {
            background: #bee3f8;
            color: #2b6cb0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .footer {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .connected {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .disconnected {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .auto-refresh {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #666;
        }
        
        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <span id="connectionText">Connecting...</span>
    </div>
    
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-title">🤖 LeanVibe Agent Hive 2.0</div>
            <div class="system-status">
                <div class="status-indicator" id="systemStatusIndicator"></div>
                <span id="systemStatusText">System Status</span>
                <div class="auto-refresh">
                    <div class="spinner"></div>
                    <span>Live Updates</span>
                </div>
            </div>
        </div>
        
        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-title">Active Projects</div>
                <div class="metric-value" id="activeProjects">-</div>
                <div class="metric-subtitle">projects in development</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Active Agents</div>
                <div class="metric-value" id="activeAgents">-</div>
                <div class="metric-subtitle">agents working</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Agent Utilization</div>
                <div class="metric-value" id="agentUtilization">-</div>
                <div class="metric-subtitle">efficiency percentage</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Tasks Completed</div>
                <div class="metric-value" id="completedTasks">-</div>
                <div class="metric-subtitle">total completed</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Active Conflicts</div>
                <div class="metric-value" id="activeConflicts">-</div>
                <div class="metric-subtitle">requiring attention</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">System Efficiency</div>
                <div class="metric-value" id="systemEfficiency">-</div>
                <div class="metric-subtitle">overall performance</div>
            </div>
        </div>
        
        <!-- Agent Activities Panel -->
        <div class="agents-panel">
            <div class="panel-title">Agent Activities</div>
            <div id="agentsList">
                <div class="item-details" style="text-align: center; color: #999;">
                    Loading agent data...
                </div>
            </div>
        </div>
        
        <!-- Projects Panel -->
        <div class="projects-panel">
            <div class="panel-title">Active Projects</div>
            <div id="projectsList">
                <div class="item-details" style="text-align: center; color: #999;">
                    Loading project data...
                </div>
            </div>
        </div>
        
        <!-- Conflicts Panel -->
        <div class="conflicts-panel">
            <div class="panel-title">Conflicts & Issues</div>
            <div id="conflictsList">
                <div class="item-details" style="text-align: center; color: #999;">
                    Loading conflict data...
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <div>LeanVibe Agent Hive 2.0 - Multi-Agent Coordination Dashboard</div>
            <div>Last Updated: <span id="lastUpdated">-</span></div>
        </div>
    </div>
    
    <script>
        class CoordinationDashboard {
            constructor() {
                this.socket = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;
                this.isConnected = false;
                
                this.init();
            }
            
            init() {
                this.connect();
                this.setupEventListeners();
            }
            
            connect() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/dashboard/ws/${this.generateConnectionId()}`;
                
                this.socket = new WebSocket(wsUrl);
                
                this.socket.onopen = (event) => {
                    console.log('Connected to dashboard WebSocket');
                    this.isConnected = true;
                    this.reconnectAttempts = 0;
                    this.updateConnectionStatus('connected');
                };
                
                this.socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };
                
                this.socket.onclose = (event) => {
                    console.log('Dashboard WebSocket closed');
                    this.isConnected = false;
                    this.updateConnectionStatus('disconnected');
                    this.attemptReconnect();
                };
                
                this.socket.onerror = (error) => {
                    console.error('Dashboard WebSocket error:', error);
                    this.isConnected = false;
                    this.updateConnectionStatus('disconnected');
                };
            }
            
            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);
                    
                    setTimeout(() => {
                        this.connect();
                    }, this.reconnectDelay * this.reconnectAttempts);
                } else {
                    console.log('Max reconnection attempts reached');
                    this.updateConnectionStatus('failed');
                }
            }
            
            updateConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                const textElement = document.getElementById('connectionText');
                
                statusElement.className = `connection-status ${status}`;
                
                switch (status) {
                    case 'connected':
                        textElement.textContent = '🟢 Connected';
                        break;
                    case 'disconnected':
                        textElement.textContent = '🟡 Reconnecting...';
                        break;
                    case 'failed':
                        textElement.textContent = '🔴 Connection Failed';
                        break;
                    default:
                        textElement.textContent = '⚪ Connecting...';
                }
            }
            
            handleMessage(data) {
                switch (data.type) {
                    case 'dashboard_initial':
                    case 'dashboard_update':
                        this.updateDashboard(data.data);
                        break;
                    case 'pong':
                        // Handle ping response
                        break;
                    default:
                        console.log('Unknown message type:', data.type);
                }
            }
            
            updateDashboard(data) {
                this.updateMetrics(data.metrics || {});
                this.updateAgentsList(data.agent_activities || []);
                this.updateProjectsList(data.project_snapshots || []);
                this.updateConflictsList(data.conflict_snapshots || []);
                
                // Update last updated time
                document.getElementById('lastUpdated').textContent = 
                    new Date(data.metrics?.last_updated || Date.now()).toLocaleTimeString();
            }
            
            updateMetrics(metrics) {
                // Update system status
                const statusIndicator = document.getElementById('systemStatusIndicator');
                const statusText = document.getElementById('systemStatusText');
                
                const status = metrics.system_status || 'unknown';
                statusIndicator.className = `status-indicator status-${status}`;
                statusText.textContent = `System ${status.charAt(0).toUpperCase() + status.slice(1)}`;
                
                // Update metric cards
                document.getElementById('activeProjects').textContent = metrics.active_projects || '-';
                document.getElementById('activeAgents').textContent = metrics.active_agents || '-';
                document.getElementById('agentUtilization').textContent = 
                    metrics.agent_utilization ? `${Math.round(metrics.agent_utilization)}%` : '-';
                document.getElementById('completedTasks').textContent = metrics.completed_tasks || '-';
                document.getElementById('activeConflicts').textContent = metrics.active_conflicts || '-';
                document.getElementById('systemEfficiency').textContent = 
                    metrics.system_efficiency ? `${Math.round(metrics.system_efficiency)}%` : '-';
            }
            
            updateAgentsList(agents) {
                const container = document.getElementById('agentsList');
                
                if (agents.length === 0) {
                    container.innerHTML = '<div class="item-details" style="text-align: center; color: #999;">No active agents</div>';
                    return;
                }
                
                container.innerHTML = agents.map(agent => `
                    <div class="agent-item agent-${agent.status}">
                        <div class="item-header">
                            <div class="item-title">${agent.name}</div>
                            <div class="item-status status-${agent.status}">${agent.status}</div>
                        </div>
                        <div class="item-details">
                            ${agent.current_project ? `🎯 ${agent.current_project}` : '💤 No active project'}<br>
                            ${agent.current_task ? `📋 ${agent.current_task}` : ''}
                            ${agent.current_task ? `<div class="progress-bar"><div class="progress-fill" style="width: ${agent.task_progress}%"></div></div>` : ''}
                            ⚡ Performance: ${Math.round(agent.performance_score * 100)}%
                        </div>
                        <div class="specializations">
                            ${agent.specializations.map(spec => `<span class="specialization-tag">${spec}</span>`).join('')}
                        </div>
                    </div>
                `).join('');
            }
            
            updateProjectsList(projects) {
                const container = document.getElementById('projectsList');
                
                if (projects.length === 0) {
                    container.innerHTML = '<div class="item-details" style="text-align: center; color: #999;">No active projects</div>';
                    return;
                }
                
                container.innerHTML = projects.map(project => `
                    <div class="project-item project-${project.status}">
                        <div class="item-header">
                            <div class="item-title">${project.name}</div>
                            <div class="item-status status-${project.status}">${project.status}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${project.progress_percentage}%"></div>
                        </div>
                        <div class="item-details">
                            📊 Progress: ${Math.round(project.progress_percentage)}%<br>
                            👥 Agents: ${project.participating_agents.length}<br>
                            ✅ Tasks: ${project.completed_tasks}/${project.completed_tasks + project.active_tasks}<br>
                            ${project.conflicts > 0 ? `⚠️ Conflicts: ${project.conflicts}` : '✅ No conflicts'}<br>
                            🎯 Quality: ${Math.round(project.quality_score)}%
                        </div>
                    </div>
                `).join('');
            }
            
            updateConflictsList(conflicts) {
                const container = document.getElementById('conflictsList');
                
                if (conflicts.length === 0) {
                    container.innerHTML = '<div class="item-details" style="text-align: center; color: #999;">✅ No active conflicts</div>';
                    return;
                }
                
                container.innerHTML = conflicts.map(conflict => `
                    <div class="conflict-item conflict-${conflict.severity}">
                        <div class="item-header">
                            <div class="item-title">${conflict.conflict_type.replace('_', ' ').toUpperCase()}</div>
                            <div class="item-status status-${conflict.severity}">${conflict.severity}</div>
                        </div>
                        <div class="item-details">
                            🏗️ Project: ${conflict.project_name}<br>
                            📝 ${conflict.description}<br>
                            👥 Affected: ${conflict.affected_agents.join(', ')}<br>
                            📈 Impact: ${Math.round(conflict.impact_score * 100)}%<br>
                            ${conflict.auto_resolvable ? '🤖 Auto-resolvable' : '👤 Requires intervention'}
                        </div>
                    </div>
                `).join('');
            }
            
            setupEventListeners() {
                // Send ping every 30 seconds to keep connection alive
                setInterval(() => {
                    if (this.isConnected) {
                        this.socket.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000);
                
                // Handle page visibility change
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && !this.isConnected) {
                        this.attemptReconnect();
                    }
                });
            }
            
            generateConnectionId() {
                return 'dashboard_' + Math.random().toString(36).substr(2, 9);
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new CoordinationDashboard();
        });
    </script>
</body>
</html>